<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Map</title>
<style type="text/css">
* { overflow: hidden; border: none; margin: 0; padding: 0; white-space: nowrap; }
</style>
<script type="text/javascript"><!--
var hexsize = 60;
var centerhex = { x: -1, y: -1 };
var offset = { x: 0, y: 0 };

function getjson(path, action)
{
	var xhr = new XMLHttpRequest();
	xhr.open("GET", path);
	xhr.onload = action;
	xhr.onerror = function() { return true; };
	xhr.send();
}

function gettile(x, y)
{
	var img = document.createElement("img");
	img.src = "unknown.png";
	img.id = "i" + x + "-" + y;
	img.useMap = "#m" + x + "-" + y;
	img.style.display = "inline";
	img.style.width = hexsize + "px";
	img.style.height = hexsize + "px";
	return img;
}

function getclickarea(x, y)
{
	var coord_nw = "0," + (hexsize/4);
	var coord_nn = (hexsize/2) + ",0";
	var coord_ne = hexsize + "," + (hexsize/4);
	var coord_se = hexsize + "," + (hexsize*3/4);
	var coord_ss = (hexsize/2) + "," + hexsize;
	var coord_sw = "0," + (hexsize*3/4);

	var map = document.createElement("map");
	map.style.display = "none";
	map.name = "m" + x + "-" + y;

	var area = document.createElement("area");
	area.id = "a" + x + "-" + y;
	area.shape = "poly";
	area.coords = coord_nw + "," + coord_nn + "," + coord_ne + "," + coord_se + "," + coord_ss + "," + coord_sw;
	area.onClick = "recenter();";
	area.ondblclick = "zoomto();";
	map.appendChild(area);

	return map;
}

function zoomto(e)
{
	console.log("zooming to");
	console.log(e);
}

function drawmap(width, height)
{
	var body = document.getElementsByTagName("body");
	for (var i = 0; i < height; i++) {
		var div = document.createElement("div");
		div.style.marginTop = "-" + (hexsize/3) + "px";
		for (var j = 0; j < width; j++) {
			div.appendChild(gettile(j, i));
			div.appendChild(getclickarea(j, i));
		}
		if (i % 2 == 1) {
			div.style.marginLeft = "-" + (hexsize/2) + "px";
		}
		body[0].appendChild(div);
	}

	/* for 10-hex wide hexes */
	/*
	var nw_halves=['1-4', '2-2', '3-1'];
	var ne_halves=['1-6', '2-7', '3-9'];
	var ww_halves=['5-0', '7-0', '9-0'];
	var ee_halves=['5-10', '7-10', '9-10'];
	var sw_halves=['11-1', '12-2', '13-4'];
	var se_halves=['11-9', '12-7', '13-6'];

	var halves = nw_halves.concat(ne_halves).concat(ww_halves).concat(ee_halves).concat(sw_halves).concat(se_halves);
	for (var h in halves) {
		var e = document.getElementById("i" + halves[h]);
		if (e) {
			e.style.opacity = 0.5;
		}
	}
	*/
}

function drawhexes()
{
	var hexwidth = window.innerWidth / hexsize;
	var hexheight = window.innerHeight / (hexsize * 3 / 4);
	centerhex.x = Math.floor(hexwidth / 2);
	centerhex.y = Math.floor(hexheight / 2);
	drawmap(Math.ceil(hexwidth), Math.ceil(hexheight) + 1);
}

function settile(x, y, terrain, href)
{
	console.log("Setting tile " + x + "," + y);
	var tile = document.getElementById("i" + x + "-" + y);
	var area = document.getElementById("a" + x + "-" + y);
	tile.src = terrain + ".png";
	area.href = href;
}

function fixtile()
{
	var tileparts = this.responseURL.split("/");
	console.log(tileparts);
	/* start at .json, count back two slashes */
	/* if more, count back two more */
	/* if more, count back two more */
	//console.log(this.responseText);
	//var tile = JSON.parse(this.responseText);
	var x = tileparts[tileparts.length-2];
	var y = tileparts[tileparts.length-1].substr(0, tileparts[tileparts.length-1].indexOf(".json"));
	console.log(x + "," + y);
	settile(x - offset.x, y - offset.y, this.responseText, this.reponseURL);
}

function worldmap()
{
	var world = { width: 400, height: 267 };
	if (this.status == 200) {
		world = JSON.parse(this.responseText);
	}
	var worldcenterx = Math.floor(world.width / 2);
	var worldcentery = Math.floor(world.height / 2);
	offset.x = worldcenterx - centerhex.x;
	offset.y = worldcentery - centerhex.y;

	//settile(centerhex.x, centerhex.y, "grass", "#" + worldcenterx + "/" + worldcentery);
	getjson("/200/132.json", fixtile);
	getjson("/200/133.json", fixtile);
	getjson("/200/134.json", fixtile);
}

function recenter()
{
	if (window.location.href.indexOf("#") == -1) {
		getjson("/world.json", worldmap);
	} else {
		console.log("Map of " + hash);
		var hash = window.location.href.substring(window.location.href.indexOf("#") + 1);
		var centerhex = hash.split("/");
		console.log(centerhex);
	}
}

// --></script>
</head>
<body onload="drawhexes(); recenter();">
</body>
</html>
